apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "service.name" . }}-config
  namespace: {{ .Release.Namespace }}
data:
  router-config.json: |+
    {
      "routingDefaults": {
        "itineraryFilters": {
          "filterItinerariesWithSameFirstOrLastTrip": true,
          "transitGeneralizedCostLimit": {
            "costLimitFunction": "3600 + 2.0 x",
            "intervalRelaxFactor": 0.4
          },
          "nonTransitGeneralizedCostLimit": "8800 + 2.0 x"
        },
        "transferSlack": 180,
        "waitReluctance": 1,
        "walkReluctance": 11,
        "maxDirectStreetDuration": "3700s",
        "maxAccessEgressDuration": "PT50"
      },
      "transit": {
        "pagingSearchWindowAdjustments": [
          "12h",
          "0h"],
        "dynamicSearchWindow": {
          "maxWindow": "PT24H"
        },
        "stopTransferCost": {
          "DISCOURAGED": 3000,
          "ALLOWED": 150,
          "RECOMMENDED": 60,
          "PREFERRED": 0
        }
      },
      "updaters": [
        {{- if .Values.otp.realtime.enabled }}
        {
          "type": "siri-azure-et-updater",
          "topic": "siri_et",
          "servicebus-url": "{{ .Values.otp.realtime.serviceBusConnectionString }}",
          "customMidnight": "{{ .Values.otp.realtime.customMidnight }}",
          "fuzzyTripMatching": false,
          "feedId": "{{ .Values.otp.realtime.feedId }}",
          {{- if .Values.otp.realtime.siriEt.history.enabled }}
          "history": {
            "url": "{{ .Values.otp.realtime.siriEt.history.url }}",
            "fromDateTime": "{{ .Values.otp.realtime.siriEt.history.fromDateTime }}",
            "timeout": "{{ .Values.otp.realtime.siriEt.history.timeout }}"
          }
          {{- end }}
        },
        {
          "type": "siri-azure-sx-updater",
          "topic": "siri_sx",
          "servicebus-url": "{{ .Values.otp.realtime.serviceBusConnectionString }}",
          "customMidnight": "{{ .Values.otp.realtime.customMidnight }}",
          "feedId": "{{ .Values.otp.realtime.feedId }}",
            {{- if .Values.otp.realtime.siriSx.history.enabled }}
          "history": {
            "url": "{{ .Values.otp.realtime.siriSx.history.url }}",
            "fromDateTime": "{{ .Values.otp.realtime.siriSx.history.publishFromDateTime }}",
            "toDateTime": "{{ .Values.otp.realtime.siriSx.history.publishToDateTime }}",
            "timeout": "{{ .Values.otp.realtime.siriSx.history.timeout }}"
          }
            {{- end }}
        }
          {{- end }}
      ]
    }
  otp-config.json: |+
{{ .Files.Get "configmap/otp-config.json" | indent 4 }}
